<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Professor Portal - Prompt Evaluation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #e6ffe6, #c8f0c8);
            color: #333;
        }

        header {
            background-color: #2c3e50;
            color: #ffffff;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            font-size: 1.8em;
            font-weight: bold;
            position: relative;
        }

        header .header-title {
            flex-grow: 1;
            text-align: center;
            font-size: 1em;
        }

        header button {
            font-size: 0.6em;
            padding: 8px 14px;
            border: none;
            background-color: #e74c3c;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }

        header button:hover {
            background-color: #c0392b;
        }

        .main-content {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .prompts-panel {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            flex: 0 0 250px; /* Fixed width for prompts panel */
            max-height: 80vh;
            overflow-y: auto;
        }

        h2 {
            color: #27ae60;
            margin: 0 0 20px 0;
            font-size: 1.7em;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .team-button {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            border: none;
            background-color: #3498db;
            color: white;
            border-radius: 8px;
            font-size: 1.05em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
        }

        .team-button.rated {
            background-color: #2ecc71;
        }

        .team-button:hover {
            background-color: #2980b9;
        }

        .team-button.rated:hover {
            background-color: #27ae60;
        }

        .rating-button {
            margin: 5px;
            padding: 10px 15px;
            font-size: 1em;
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: bold;
        }

        .rating-button:hover {
            background-color: #ddd;
        }

        .rating-button.selected {
            background-color: #2ecc71;
            color: white;
        }

        /* Modal for Prompt and Simulation View */
        #promptSimulationModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        #promptSimulationModalContent {
            background: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 900px; /* Reverted max-width for stacked layout */
            max-height: 95vh; /* Allow modal to take most of viewport height */
            overflow-y: auto; /* Allow the entire modal content to scroll if needed */
            position: relative;
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            gap: 20px; /* Space between sections */
            align-items: center; /* Center content horizontally */
        }

        #modalCloseBtn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.2em;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
        }

        #modalCloseBtn:hover {
            color: #333;
        }

        #modalTitle {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
            width: 100%; /* Ensure title spans full width */
        }

        #promptTextDisplay {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 1em;
            color: #444;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
            width: 100%; /* Take full width of modal content */
            max-height: 200px; /* Limit height and enable scrolling for long prompts */
            overflow-y: auto;
            box-sizing: border-box; /* Include padding in width */
        }

        #ratingScale {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            margin-top: 10px;
            margin-bottom: 10px; /* Space before simulation */
        }

        #simulationIframeContainer {
            width: 100%;
            max-width: 800px; /* Consistent max-width for the simulation iframe */
            height: 450px; /* Fixed height for the embedded simulation */
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
            margin: 0 auto; /* Center the iframe container */
        }

        #simulationIframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Custom Modal for Alerts and Confirmations - for consistency */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .custom-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }

        .custom-modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .custom-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        .custom-modal-btn.yes {
            background-color: #28a745;
            color: white;
        }

        .custom-modal-btn.yes:hover {
            background-color: #218838;
        }

        .custom-modal-btn.no {
            background-color: #dc3545;
            color: white;
        }

        .custom-modal-btn.no:hover {
            background-color: #c82333;
        }

        .custom-modal-btn.ok {
            background-color: #007bff;
            color: white;
        }

        .custom-modal-btn.ok:hover {
            background-color: #0056b3;
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
                align-items: center;
            }

            .prompts-panel {
                width: 95%;
                flex: none; /* Remove flex-grow on smaller screens */
            }
            
            #promptSimulationModalContent {
                max-width: 95%; /* Allow modal to take more width */
                max-height: 90vh; /* Adjust height */
            }

            #simulationIframeContainer {
                height: 300px; /* Adjust height for smaller screens */
            }
        }
        @media (max-width: 600px) {
            .container { padding: 20px; }
            h1 { font-size: 1.8em; }
            .button { padding: 12px 20px; }
            .custom-modal-content { width: 95%; padding: 20px; }
        }
    </style>
</head>

<body>
    <header>
        <span class="header-title">Professor Dashboard - NH9 Cattle Problem</span>
        <button onclick="refreshPrompts()">
            ðŸ”„ Clear All Prompts
        </button>
    </header>

    <div class="main-content">
        <div class="prompts-panel">
            <h2>Team Prompts</h2>
            <div id="promptsList">
                <!-- Team buttons will be dynamically generated here -->
                <p>Loading team data...</p>
            </div>
        </div>

        <!-- The main simulation panel is removed as it's now exclusively in the modal -->
    </div>

    <!-- Modal for Prompt and Simulation View -->
    <div id="promptSimulationModal">
        <div id="promptSimulationModalContent">
            <button id="modalCloseBtn" onclick="closePromptSimulationModal()">âœ–</button>
            <h3 id="modalTitle">Team Prompt and Simulation</h3>

            <div id="promptTextDisplay"></div>

            <div>
                <label><strong>Rate this Prompt (out of 10):</strong></label>
                <div id="ratingScale">
                    <!-- Rating buttons will be dynamically added here -->
                </div>
            </div>

            <div id="simulationIframeContainer">
                <iframe id="simulationIframe" src="" title="Team Simulation"></iframe>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts and Confirmations -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <p id="customModalText"></p>
            <div id="customModalButtons" class="custom-modal-buttons">
                <!-- Buttons will be dynamically added here -->
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, writeBatch, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        // --- DOM Elements ---
        const promptsList = document.getElementById("promptsList");
        const promptSimulationModal = document.getElementById("promptSimulationModal");
        const modalTitle = document.getElementById("modalTitle");
        const promptTextDisplay = document.getElementById("promptTextDisplay");
        const ratingScale = document.getElementById("ratingScale");
        const simulationIframe = document.getElementById("simulationIframe");

        // Custom modal elements (for consistency in alerts)
        const customModal = document.getElementById('customModal');
        const customModalText = document.getElementById('customModalText');
        const customModalButtons = document.getElementById('customModalButtons');

        // --- Firebase Variables ---
        let db;
        let auth;
        let userId;
        let unsubscribeFromPrompts = null; // To store the unsubscribe function for prompts listener
        let currentTeamIdInModal = null; // Stores the team ID currently displayed in the modal

        // --- Constants ---
        const ALL_TEAMS = ['team1', 'team2', 'team3', 'team4', 'team5', 'team6'];

        /**
         * Shows a custom alert or confirmation modal, replacing native alert/confirm.
         * @param {string} message - The message to display in the modal.
         * @param {'alert'|'confirm'} type - The type of modal: 'alert' for OK button, 'confirm' for Yes/No buttons.
         * @returns {Promise<boolean>} Resolves to true for 'OK'/'Yes', false for 'No'.
         */
        function showCustomModal(message, type) {
            return new Promise(resolve => {
                customModalText.textContent = message;
                customModalButtons.innerHTML = ''; // Clear existing buttons

                if (type === 'alert') {
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.className = 'custom-modal-btn ok';
                    okButton.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(true);
                    };
                    customModalButtons.appendChild(okButton);
                } else if (type === 'confirm') {
                    const yesButton = document.createElement('button');
                    yesButton.textContent = 'Yes';
                    yesButton.className = 'custom-modal-btn yes';
                    yesButton.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(true);
                    };

                    const noButton = document.createElement('button');
                    noButton.textContent = 'No';
                    noButton.className = 'custom-modal-btn no';
                    noButton.onclick = () => {
                        customModal.style.display = 'none';
                        resolve(false);
                    };
                    customModalButtons.appendChild(yesButton);
                    customModalButtons.appendChild(noButton);
                }
                customModal.style.display = 'flex'; // Show the modal
            });
        }

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initializeFirebaseAndAuth() {
            console.log("Professor: Attempting to initialize Firebase...");
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'ghaziabad-nh9-cattle-problem';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
                    apiKey: "AIzaSyBODgdU_1yk9_PvZHxWiY3oo8RuFDuI7DA",
                    authDomain: "ghaziabad-nh9-cattle-problem.firebaseapp.com",
                    projectId: "ghaziabad-nh9-cattle-problem",
                    storageBucket: "ghaziabad-nh9-cattle-problem.firebasestorage.app",
                    messagingSenderId: "226795420666",
                    appId: "1:226795420666:web:7d4bdd780f7ff43dfd8243",
                    measurementId: "G-PDY8Q17Q0K"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Professor: Firebase app initialized.");

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Professor: Firebase authenticated. User ID:", userId);
                        setupRealtimePromptListener(); // Start listening for prompts
                    } else {
                        console.log("Professor: No user signed in.");
                        userId = null;
                        promptsList.innerHTML = "<p>Please ensure Firebase is configured and you have network access.</p>";
                    }
                });
            } catch (error) {
                console.error("Professor: CRITICAL ERROR: Firebase initialization failed:", error);
                await showCustomModal(`Failed to initialize application: ${error.message}. Check console for details.`, 'alert');
                promptsList.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        /**
         * Sets up a real-time listener for prompts in Firestore.
         * Dynamically generates 6 team buttons and updates their state based on submitted prompts.
         */
        function setupRealtimePromptListener() {
            if (unsubscribeFromPrompts) {
                unsubscribeFromPrompts(); // Unsubscribe from previous listener if any
            }
            console.log("Professor: Setting up real-time prompt listener.");

            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'ghaziabad-nh9-cattle-problem';
            const promptsCollectionRef = collection(db, `artifacts/${currentAppId}/public/data/prompts`);
            const q = query(promptsCollectionRef);

            // Listen for real-time updates
            unsubscribeFromPrompts = onSnapshot(q, (snapshot) => {
                const promptsData = {};
                snapshot.forEach(docSnap => {
                    promptsData[docSnap.id] = docSnap.data();
                });
                console.log(`Professor: Received ${snapshot.size} prompts from Firestore.`);

                promptsList.innerHTML = ""; // Clear existing list

                ALL_TEAMS.forEach(teamId => {
                    const btn = document.createElement("button");
                    btn.id = `team-button-${teamId}`; // Add an ID for easier reference
                    btn.textContent = `Team-${teamId.replace('team', '')}`;
                    btn.className = "team-button";

                    const prompt = promptsData[teamId];
                    if (prompt) {
                        if (prompt.rating !== null && prompt.rating !== undefined) {
                            const ratingDisplay = document.createElement("span");
                            ratingDisplay.textContent = ` (${prompt.rating}/10)`;
                            ratingDisplay.style.marginLeft = '10px';
                            ratingDisplay.style.fontWeight = 'bold';
                            btn.appendChild(ratingDisplay);
                            btn.classList.add('rated');
                        }
                    } else {
                        // If no prompt, indicate it
                        const noPromptSpan = document.createElement("span");
                        noPromptSpan.textContent = " (No Prompt)";
                        noPromptSpan.style.marginLeft = '10px';
                        noPromptSpan.style.color = '#777';
                        btn.appendChild(noPromptSpan);
                    }

                    // Attach click handler to open the modal with prompt and simulation
                    btn.onclick = () => openTeamModal(teamId, prompt);
                    promptsList.appendChild(btn);
                });
            }, (error) => {
                console.error("Professor: Error listening to prompts:", error);
                promptsList.innerHTML = `<p style="color: red;">Error loading prompts: ${error.message}</p>`;
                showCustomModal(`Error loading real-time prompts: ${error.message}`, 'alert');
            });
        }

        /**
         * Opens the modal displaying the prompt and the simulation for the selected team.
         * @param {string} teamId - The ID of the selected team (e.g., 'team1').
         * @param {Object|null} promptData - The prompt data for the team, or null if no prompt.
         */
        function openTeamModal(teamId, promptData) {
            currentTeamIdInModal = teamId;
            modalTitle.textContent = `${teamId.replace('team', 'Team-')}'s Prompt and Simulation`;

            // Display prompt text
            if (promptData && promptData.promptText) {
                promptTextDisplay.textContent = promptData.promptText;
            } else {
                promptTextDisplay.textContent = "No prompt submitted for this team yet.";
            }

            // Generate rating buttons
            ratingScale.innerHTML = "";
            for (let i = 1; i <= 10; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.className = "rating-button";
                if (promptData && promptData.rating !== null && parseInt(promptData.rating) === i) {
                    btn.classList.add('selected');
                }
                btn.onclick = () => ratePrompt(teamId, i);
                ratingScale.appendChild(btn);
            }

            // Load the simulation iframe for the specific team, passing role=professor
            simulationIframe.src = `simulation.html?teamId=${teamId}&role=professor`;

            // Show the modal
            promptSimulationModal.style.display = "flex";

            // Once the iframe is loaded, send it the team ID and role to ensure it's listening correctly
            simulationIframe.onload = () => {
                simulationIframe.contentWindow.postMessage({ type: 'SET_TEAM_ID', teamId: teamId, role: 'professor' }, '*');
            };
            console.log(`Professor: Opened modal for ${teamId}.`);
        }

        /**
         * Closes the prompt and simulation modal.
         */
        function closePromptSimulationModal() {
            promptSimulationModal.style.display = "none";
            simulationIframe.src = ""; // Clear iframe src to stop its listener
            currentTeamIdInModal = null;
            console.log("Professor: Prompt/Simulation modal closed.");
        }

        /**
         * Handles rating a prompt and updates it in Firestore.
         * @param {string} teamId - The ID of the team being rated.
         * @param {number} rating - The assigned rating (1-10).
         */
        async function ratePrompt(teamId, rating) {
            if (!db) {
                await showCustomModal("Firebase not initialized. Cannot rate prompt.", 'alert');
                return;
            }
            console.log(`Professor: Rating ${teamId} with ${rating}/10.`);

            const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'ghaziabad-nh9-cattle-problem';
            const promptDocRef = doc(db, `artifacts/${currentAppId}/public/data/prompts`, teamId);
            try {
                await setDoc(promptDocRef, { rating: rating }, { merge: true });
                await showCustomModal(`You rated ${teamId.replace('team', 'Team-')}'s prompt: ${rating}/10`, 'alert');
                // The onSnapshot listener for prompts will automatically update the button in promptsList
            } catch (error) {
                console.error("Professor: Error setting rating:", error);
                await showCustomModal(`Failed to set rating: ${error.message}`, 'alert');
            }
        }

        /**
         * Handles clearing all prompts and ratings from Firestore.
         */
        async function refreshPrompts() {
            console.log("Professor: 'Clear All Prompts' button clicked.");
            const confirmClear = await showCustomModal("Are you sure you want to clear ALL prompts and ratings? This cannot be undone.", 'confirm');
            if (!confirmClear) {
                console.log("Professor: Clear operation cancelled by user.");
                return;
            }

            try {
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'ghaziabad-nh9-cattle-problem';
                const promptsCollectionRef = collection(db, `artifacts/${currentAppId}/public/data/prompts`);
                const cowStatesCollectionRef = collection(db, `artifacts/${currentAppId}/public/data/cow_states`);

                const batch = writeBatch(db);

                // Delete all prompts
                const promptQuerySnapshot = await getDocs(query(promptsCollectionRef));
                promptQuerySnapshot.docs.forEach((docSnap) => {
                    batch.delete(docSnap.ref);
                });
                console.log(`Professor: Added ${promptQuerySnapshot.size} prompts to batch for deletion.`);

                // Delete all cow states
                const cowStateQuerySnapshot = await getDocs(query(cowStatesCollectionRef));
                cowStateQuerySnapshot.docs.forEach((docSnap) => {
                    batch.delete(docSnap.ref);
                });
                console.log(`Professor: Added ${cowStateQuerySnapshot.size} cow states to batch for deletion.`);

                await batch.commit();

                await showCustomModal("All team prompts, ratings, and cow states have been cleared!", 'alert');
                console.log("Professor: All data cleared from Firestore.");
                // onSnapshot listeners will automatically update the UI
            } catch (error) {
                console.error("Professor: Error clearing data:", error);
                await showCustomModal(`Failed to clear data: ${error.message}`, 'alert');
            }
        }

        // Initialize Firebase and Authentication when the script loads
        initializeFirebaseAndAuth();

        // Expose functions to the global scope for HTML attributes to call
        window.refreshPrompts = refreshPrompts;
        window.openTeamModal = openTeamModal;
        window.closePromptSimulationModal = closePromptSimulationModal;
    </script>
</body>
</html>
